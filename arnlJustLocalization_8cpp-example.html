<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>ARNL: arnlJustLocalization.cpp</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.6 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>arnlJustLocalization.cpp</h1>Example which does localization only, but provides servers for remote operation with MobileEyes.<p>
<div class="fragment"><pre class="fragment">

<span class="preprocessor">#include "Aria.h"</span>
<span class="preprocessor">#include "ArNetworking.h"</span>
<span class="preprocessor">#include "Arnl.h"</span>

<span class="preprocessor">#include "ArLocalizationTask.h"</span>



<span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
{
  Aria::init();
  Arnl::init();

  ArRobot robot;
  ArServerBase server;
  ArArgumentParser parser(&amp;argc, argv);
  parser.loadDefaultArguments();
  ArSimpleConnector simpleConnector(&amp;parser);
  ArServerSimpleOpener simpleOpener (&amp;parser);
  ArAnalogGyro gyro (&amp;robot);

  parser.loadDefaultArguments();
  <span class="keywordflow">if</span> (!Aria::parseArgs () || !parser.checkHelpAndWarnUnparsed())
  {
    Aria::logOptions ();
    Aria::exit (1);
  }

  ArSick sick;
  robot.addRangeDevice (&amp;sick);

  ArSonarDevice sonarDev;
  robot.addRangeDevice (&amp;sonarDev);

  ArBumpers bumpers;
  robot.addRangeDevice (&amp;bumpers);

  <span class="comment">// Use the "examples" directory as a place to keep map files</span>
  <span class="keywordtype">char</span> fileDir[1024];
  ArUtil::addDirectories (fileDir, <span class="keyword">sizeof</span> (fileDir), Aria::getDirectory (),
            <span class="stringliteral">"examples"</span>);

  <span class="comment">// Set up the map, this will look for files in the examples</span>
  <span class="comment">// directory (unless the file name starts with a / \ or .</span>
  <span class="comment">// You can take out the argument to look in the current directory</span>
  ArMap arMap (fileDir);
  <span class="comment">// set it up to ignore empty file names (otherwise the parseFile</span>
  <span class="comment">// on the config will fail)</span>
  arMap.setIgnoreEmptyFileName (<span class="keyword">true</span>);


  <a name="_a0"></a><a class="codeRef" doxygen="BaseArnl.tag:../BaseArnl-Reference//" href="../BaseArnl-Reference//classArLocalizationManager.html">ArLocalizationManager</a> locManager(&amp;robot, &amp;arMap);
  <a name="_a1"></a><a class="code" href="classArLocalizationTask.html" title="Task that performs continuous localization of the robot with a laser range sensor...">ArLocalizationTask</a> locTask (&amp;robot, &amp;sick, &amp;arMap);
  locManager.<a name="a2"></a><a class="codeRef" doxygen="BaseArnl.tag:../BaseArnl-Reference//" href="../BaseArnl-Reference//classArLocalizationManager.html#724677bf1495bf4e7547018d6385f3b9">addLocalizationTask</a>(&amp;locTask);



  <span class="comment">// Add log controls to configuration</span>
  ArLog::addToConfig (Aria::getConfig ());

  <span class="comment">// Open the server port</span>
  <span class="keywordflow">if</span> (!simpleOpener.open (&amp;server, fileDir, 240))
  {
    ArLog::log (ArLog::Normal, <span class="stringliteral">"Could not open server port"</span>);
    exit (2);
  }

  <span class="comment">// Connect to the robot</span>
  <span class="keywordflow">if</span> (!simpleConnector.connectRobot (&amp;robot))
  {
    ArLog::log (ArLog::Normal, <span class="stringliteral">"Could not connect to robot... exiting"</span>);
    Aria::exit (3);
  }

  robot.enableMotors ();
  robot.clearDirectMotion ();

  <span class="comment">// reset the simulator to its start position</span>
  robot.com(ArCommands::SIM_RESET);

  simpleConnector.setupLaser (&amp;sick);

  <span class="comment">// run robot task cycle</span>
  robot.runAsync (<span class="keyword">true</span>);

  <span class="comment">// Run SICK thread and try to connect</span>
  sick.runAsync ();
  <span class="keywordflow">if</span> (!sick.blockingConnect ())
  {
    ArLog::log (ArLog::Normal, <span class="stringliteral">"Couldn't connect to laser, exiting"</span>);
    Aria::exit (4);
  }

  ArUtil::sleep (300);

  <span class="comment">// Forbidden regions from the map.</span>
  ArForbiddenRangeDevice forbidden (&amp;arMap);
  robot.addRangeDevice (&amp;forbidden);

  <span class="comment">// Objects that provide network services:</span>
  ArServerInfoRobot serverInfoRobot (&amp;server, &amp;robot);
  ArServerInfoSensor serverInfoSensor (&amp;server, &amp;robot);
  <a name="_a3"></a><a class="codeRef" doxygen="BaseArnl.tag:../BaseArnl-Reference//" href="../BaseArnl-Reference//classArServerInfoLocalization.html">ArServerInfoLocalization</a> serverInfoLocalization (&amp;server, &amp;robot, &amp;locManager);
  <a name="_a4"></a><a class="codeRef" doxygen="BaseArnl.tag:../BaseArnl-Reference//" href="../BaseArnl-Reference//classArServerHandlerLocalization.html">ArServerHandlerLocalization</a> serverLocHandler (&amp;server, &amp;robot, &amp;locManager);
  ArServerHandlerMap serverMap (&amp;server, &amp;arMap);

  <span class="comment">// Drawing services in the map display:</span>
  ArServerInfoDrawings drawings (&amp;server);
  drawings.addRobotsRangeDevices (&amp;robot);

  <span class="comment">// Misc. "custom " commands:</span>
  ArServerHandlerCommands commands (&amp;server);
  ArServerSimpleComUC uCCommands (&amp;commands, &amp;robot);
  ArServerSimpleComMovementLogging loggingCommands (&amp;commands, &amp;robot);
  ArServerSimpleComGyro gyroCommands (&amp;commands, &amp;robot, &amp;gyro);
  ArServerSimpleComLogRobotConfig configCommands (&amp;commands, &amp;robot);

  <span class="comment">// Set up the possible modes for remote control from a client such as</span>
  <span class="comment">// MobileEyes:</span>

  <span class="comment">// To stop and remain stopped:</span>
  ArServerModeStop modeStop (&amp;server, &amp;robot);
  modeStop.addAsDefaultMode ();

  <span class="comment">// Disable the sonar automatically if stopped and enable when we</span>
  <span class="comment">// move</span>
  ArSonarAutoDisabler sonarAutoDisabler (&amp;robot);

  <span class="comment">// Teleoperate by keyboard, joystick, etc:</span>
  ArServerModeRatioDrive modeRatioDrive (&amp;server, &amp;robot);

  <span class="comment">// Teloperation mode's configuration and special commands:</span>
  modeRatioDrive.addControlCommands (&amp;commands);
  modeRatioDrive.addToConfig (Aria::getConfig (), <span class="stringliteral">"Teleop settings"</span>);

  <span class="comment">// Wander mode:</span>
  ArServerModeWander
  modeWander (&amp;server, &amp;robot);

  <span class="comment">// Prevent driving if localization is lost:</span>
  <a name="_a5"></a><a class="codeRef" doxygen="BaseArnl.tag:../BaseArnl-Reference//" href="../BaseArnl-Reference//classArActionLost.html">ArActionLost</a> actionLostRatioDrive (&amp;locManager, NULL, &amp;modeRatioDrive);
  modeRatioDrive.getActionGroup ()-&gt;addAction (&amp;actionLostRatioDrive, 110);

  <span class="comment">// Prevent wandering if lost:</span>
  <a class="codeRef" doxygen="BaseArnl.tag:../BaseArnl-Reference//" href="../BaseArnl-Reference//classArActionLost.html">ArActionLost</a>
  actionLostWander (&amp;locManager, NULL, &amp;modeWander);
  modeWander.getActionGroup ()-&gt;addAction (&amp;actionLostWander, 110);

  <span class="comment">// This provides a small table of interesting information for the client</span>
  <span class="comment">// to display to the operator:</span>
     ArServerInfoStrings
     stringInfo (&amp;server);
  Aria::getInfoGroup ()-&gt;addAddStringCallback (stringInfo.
                         getAddStringFunctor ());

  <span class="comment">// Display localization score and more</span>
  Aria::getInfoGroup ()-&gt;addStringDouble (<span class="stringliteral">"Localization Score"</span>, 8,
                    <span class="keyword">new</span> ArRetFunctorC &lt; <span class="keywordtype">double</span>,
                    <a class="code" href="classArLocalizationTask.html" title="Task that performs continuous localization of the robot with a laser range sensor...">ArLocalizationTask</a> &gt; (&amp;locTask,
                                  &amp;<a class="code" href="classArLocalizationTask.html" title="Task that performs continuous localization of the robot with a laser range sensor...">ArLocalizationTask</a>::
                                  getLocalizationScore),
                    <span class="stringliteral">"%.03f"</span>);
  Aria::getInfoGroup ()-&gt;addStringInt (<span class="stringliteral">"Laser Packet Count"</span>, 10,
                     <span class="keyword">new</span> ArRetFunctorC &lt; int, ArSick &gt; (&amp;sick,
                                    &amp;ArSick::
                                    getSickPacCount));


Aria::getInfoGroup ()-&gt;addStringInt (<span class="stringliteral">"Motor Packet Count"</span>, 10,
                     <span class="keyword">new</span> ArConstRetFunctorC &lt; <span class="keywordtype">int</span>,
                     ArRobot &gt; (&amp;robot,
                        &amp;ArRobot::getMotorPacCount));


  <span class="comment">// Create service that allows client to change configuration parameters in ArConfig </span>
  ArServerHandlerConfig handlerConfig (&amp;server, Aria::getConfig (),
                     Arnl::getTypicalDefaultParamFileName (),
                     Aria::getDirectory ());



  <span class="comment">// Read in parameter files.</span>
  Aria::getConfig ()-&gt;useArgumentParser (&amp;parser);
  <span class="keywordflow">if</span> (!Aria::getConfig ()-&gt;parseFile (Arnl::getTypicalParamFileName ()))
  {
    ArLog::log (ArLog::Normal, <span class="stringliteral">"Trouble loading configuration file, exiting"</span>);
    Aria::exit (5);
  }

  <span class="comment">// Error if there is no map</span>
  <span class="keywordflow">if</span> (arMap.getFileName () == NULL || strlen (arMap.getFileName ()) &lt;= 0)
  {
    ArLog::log(ArLog::Terse, <span class="stringliteral">"Warning, no map given. Use the -map command-line argument or modify the config using MobileEyes or by editing the parameter file."</span>);
    ArLog::log(ArLog::Terse, <span class="stringliteral">"See the  documentation, including MAPPING.txt or SONAR_MAPPING.txt."</span>);
  }

  ArLog::log (ArLog::Normal, <span class="stringliteral">"Directory for maps and file serving: %s"</span>, fileDir);

  ArLog::log (ArLog::Normal, <span class="stringliteral">"See the  README.txt for more information"</span>);


  robot.unlock();


  <span class="comment">// Localize robot at home.</span>
  locTask.<a name="a6"></a><a class="code" href="classArLocalizationTask.html#5f03ae43cbb2d0ca0f0c9d4277858fa1" title="Try initial localization at each home point at the map, and set the robot pose to...">localizeRobotAtHomeBlocking</a>();
  
  server.runAsync();

  ArLog::log(ArLog::Normal, <span class="stringliteral">"Server now running on port %d. Press Control-C to exit."</span>, server.getTcpPort());


  robot.waitForRunExit();
  Aria::exit(0);

}

</pre></div> </div>
<hr size="1"><address style="text-align: right;"><small>Generated on Thu Apr 9 12:21:30 2009 for ARNL by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.6 </small></address>
</body>
</html>
